#https://stackoverflow.com/questions/63990487/package-conflict-with-anaconda
#IMPORTANT: By telling conda that it can visit multiple channels (conda-forge, bioconda and defaults), it has some extra options to resolve the dependency conflicts.

cd raw_data
for file in *.fastq.gz; do mv $file $(echo $file | cut -d'_' -f1)_$(echo $file | cut -d'_' -f4).fastq.gz; done
cd ..
git clone https://github.com/huang/bacto
mv bacto/* ./
rmdir bacto
#-- we should create two environments: prokka and bacto2 --> SUCCESSFUL
# ---------------------- install env prokka ---------------------
conda create -n prokka -c conda-forge -c bioconda -c defaults python=3.7 prokka
(prokka) conda install -c conda-forge -c bioconda -c defaults shovill mlst trimmomatic
#(prokka) conda install -c conda-forge -c bioconda -c defaults snakemake

## ---- install env snippy on conda or host-env (NOT NEED ANYMORE, Since bacto2 get repaired by 'export PERL5LIB=$CONDA_PREFIX/lib/perl5/site_perl/5.22.0/') ----
#-- install snippy using conda failed --
#conda activate base
#conda update --all --yes
#conda create -n snippy
#conda activate snippy
#(snippy) conda install -c conda-forge -c bioconda -c defaults snippy=4.6 roary
#(snippy) conda list (To check version is above 4)
#(snippy) snippy --check

##-- install brew and snippy to ubuntu host-env --
##https://www.how2shout.com/linux/how-to-install-brew-ubuntu-20-04-lts-linux/#google_vignette
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
##add 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' to .bashrc
#source ~/.bashrc
#brew install brewsci/bio/snippy

# ---------------------- install env bacto2 ---------------------
conda create -n bacto2 -c conda-forge -c bioconda -c defaults python=3.7
conda activate bacto2
(bacto2) conda install -c conda-forge -c bioconda -c defaults trimmomatic fastqc shovill 
(bacto2) conda install -c conda-forge -c bioconda -c defaults mlst roary snippy fasttree 
#(bacto2) cpanm Bio::Roary  #DEBUG NOT WORKING
(bacto2) export PERL5LIB=$CONDA_PREFIX/lib/perl5/site_perl/5.22.0/  #DEBUG SUCCESSFUL, repaired also snippy and snippy-core
(bacto2) conda install -c conda-forge -c bioconda -c defaults raxml-ng gubbins snp-sites
#(bacto2) conda install -c conda-forge -c bioconda -c defaults perl-bioperl
#(bacto2) cpanm Bio::SeqIO
#(bacto2) cpanm Bio::Perl
#(bacto2) conda install -c conda-forge -c bioconda -c defaults biopython
#(bacto2) conda install -c conda-forge -c bioconda -c defaults snakemak

# ------------ using prokka for first three steps and bacto2 for last 5 steps --------------
(prokka) for the first 3 steps (f,f,t,f,t,f,f,f,f,f in bacto-0.1.json)

# ---- The strategies for choosing the best reference ----
#1. if the reference is given in bacto-0.1.json.
(bacto2 on titisee) for the remaining steps (f,f,f,f,f,t,f,t,t,t in bacto-0.1.json)

#2. if the reference is given in bacto-0.1.json, for example in project C.acnes.
(bacto2 on titisee) for the step roary (f,f,f,f,f,t,f,f,f,f in bacto-0.1.json) generating roary.
(bacto2 on titisee) ./roary$ samtools faidx core_gene_alignment.aln
(bacto2 on titisee) ./roary$ fasttree -gtr -nt core_gene_alignment.aln > core_gene_alignment.tree
(bacto2 on titisee) ./roary$ snp-sites core_gene_alignment.aln > core_gene_alignment_.aln     #372992 --> 16848
(bacto2 on titisee) ./roary$ raxml-ng --all --model GTR+G+ASC_LEWIS --prefix core_gene_raxml --threads 6 --msa core_gene_alignment_.aln --bs-trees 1000

#3. seek the next closely reference
(referenceseeker) ~/Tools/referenceseeker/bin/referenceseeker -v ~/REFs/bacteria-refseq/ shovill/E50862/contigs.fa
#ID     Mash Distance   ANI     Con. DNA        Taxonomy ID     Assembly Status Organism
GCF_001281065.1 0.00712 98.70   91.86   1747    complete        Cutibacterium acnes KCOM 1861 (= ChDC B594)
GCF_000231215.1 0.00710 98.51   91.85   1091045 complete        Cutibacterium acnes subsp. defendens ATCC 11828
GCF_000240055.1 0.01125 98.42   91.54   1114969 complete        Cutibacterium acnes TypeIA2 P.acn31
GCF_006739385.1 0.01108 98.42   91.48   1734925 complete        Cutibacterium acnes subsp. acnes NBRC 107605
GCF_000008345.1 0.01085 98.43   91.41   267747  complete        Cutibacterium acnes KPA171202


#4. choose and annotate an isolate as reference (using spandx)
#-4.1. generate PseudoContig_wildtype.fasta --
#./shovill/noAB_wildtype/contigs.fasta
~/Tools/CONTIGuator_v2.7/CONTIGuator.py -r CP040849.fasta -a /home/jhuang/Tools/act.jar -c shovill/noAB_wildtype/contigs.fa 
~/Tools/CONTIGuator_v2.7/CONTIGuator.py -r CP059793.fasta -a /home/jhuang/Tools/act.jar -c shovill/noAB_wildtype/contigs.fa 
merge_seq.py Excluded.fsa > ../Excluded_sequence.fasta
#add Excluded_sequence.fasta to PseudoContig.fsa or only use PseudoContig.fsa

prokka PseudoContig_wildtype.fasta #result in PROKKA_01242022
#../../vrap/external_tools/blast/makeblastdb -in nucleotide.fa -dbtype nucl -parse_seqids -out nucleotide.fasta
python ~/Tools/VAPiD/vapid3.py --db ~/REFs/all_virus/all_virus.fasta contigs.fa ~/REFs/template_Fischer.sbt
python ~/Tools/VAPiD/vapid3.py --db ~/REFs/all_virus/all_virus.fasta contigs.fa ~/REFs/template_Holger.sbt

#-4.2. generate genebank in snpEff for noAB_wildtype --
mkdir ~/anaconda3/envs/spandx/share/snpeff-4.3.1t-5/data/noAB_wildtype
cp PROKKA_01242022/PROKKA_01242022.gbk ~/anaconda3/envs/spandx/share/snpeff-4.3.1t-5/data/noAB_wildtype/genes.gbk
vim ~/anaconda3/envs/spandx/share/snpeff-4.3.1t-5/snpEff.config
/home/jhuang/anaconda3/envs/spandx/bin/snpEff build -genbank noAB_wildtype      -d


#-4.3. using spandx calling variants --
#ln -s /home/jhuang/Tools/spandx/ spandx
#-t
snpEff eff -nodownload -no-downstream -no-intergenic -ud 100 -v CP040849.1 noAB_wildtype_trimmed.PASS.snps.vcf > noAB_wildtype_trimmed.PASS.snps.annotated.vcf
#
#               'CP040849'      2659111 Standard
(spandx) nextflow run spandx/main.nf --fastq "trimmed/*_P_{1,2}.fastq.gz" --ref PseudoContig_wildtype.fasta --annotation --database noAB_wildtype -resume








#---------------------------------------- TRASH ---------------------------------------
#snippy is not required in the project C.acnes: (host-env on titisee) for the steps snippy (f,f,f,f,f,f,t,f,f,f in bacto-0.1.json)
#snippy-core is not required in the project C.acnes: (bengal3_ac3 on hamburg) for the step snippy-core (f,f,f,f,f,f,t,f,f,f in bacto-0.1.json)


#----install BioPerl in root-env----
#sudo apt install cpanminus
#cpanm Bio::Root::Version  #--> Successfully installed BioPerl-1.7.8 (upgraded from 1.7.7)


#conda create -n bacto3 python=3.7 libgcc-ng=7.3 libstdcxx-ng=7.3
#conda install -c bioconda prokka perl-bioperl
conda install -c bioconda prokka perl-bioperl perl-datetime perl-xml-simple perl-digest-md5 perl-bio-searchio-hmmer
#-->ERROR: ! Installing the dependencies failed: Module 'XML::Parser::PerlSAX' is not installed, Module 'DB_File' is not installed, Module 'XML::LibXML' is not installed, Module 'Test::Memory::Cycle' is not installed, Module 'XML::DOM' is not installed, Module 'Graph::Directed' is not installed, Module 'XML::Twig' is not installed, Module 'XML::LibXML::Reader' is not installed
! Bailing out the installation for BioPerl-1.7.8.

#conda install -c bioconda trimmomatic fastqc shovill prokka mlst roary snippy fasttree raxml-ng gubbins snp-sites
conda install -c bioconda trimmomatic roary fasttree raxml-ng mlst gubbins
conda install -c conda-forge biopython

#---- brew is not a good idea: DEACTIVATing it in .bashrc ----
#DEBUG prokka error: https://github.com/tseemann/prokka/issues/446
#cpan 
#install Bio::Perl Time::Piece XML::Simple Digest::MD5
#conda install -c bioconda perl-xml-simple perl-bioperl
#Solution: https://github.com/tseemann/prokka/issues/528
#sudo apt install bioperl libdatetime-perl libxml-simple-perl libdigest-md5-perl libbio-searchio-hmmer-perl

#brew install brewsci/bio/prokka
#brew install brewsci/bio/shovill
#brew install brewsci/bio/snippy  #which also installs snp-sites

#conda env create -f=envs/bengal_m.yaml    # python3 is included
#conda env update -f=envs/mykrobe_m.yaml
#conda activate bengal3_ac3
conda install -c bioconda ariba
#conda install snp-sites
conda install seq-seq-pan


#conda remove -n bengal --all
#conda remove -n bengal2 --all

